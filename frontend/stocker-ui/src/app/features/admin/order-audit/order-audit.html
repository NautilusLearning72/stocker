<mat-sidenav-container class="audit-container">
  <!-- Main Content -->
  <mat-sidenav-content>
    <div class="audit-content">
      <!-- Filters Panel -->
      <mat-card class="filters-card">
        <div class="filters-row">
          <mat-form-field appearance="outline" class="filter-field date-field">
            <mat-label>From Date</mat-label>
            <input matInput [matDatepicker]="fromPicker" [(ngModel)]="dateFrom">
            <mat-datepicker-toggle matIconSuffix [for]="fromPicker"></mat-datepicker-toggle>
            <mat-datepicker #fromPicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline" class="filter-field date-field">
            <mat-label>To Date</mat-label>
            <input matInput [matDatepicker]="toPicker" [(ngModel)]="dateTo">
            <mat-datepicker-toggle matIconSuffix [for]="toPicker"></mat-datepicker-toggle>
            <mat-datepicker #toPicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline" class="filter-field symbol-field">
            <mat-label>Symbol</mat-label>
            <input matInput [(ngModel)]="symbolFilter" placeholder="e.g., AAPL">
          </mat-form-field>

          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Status</mat-label>
            <mat-select [(ngModel)]="statusFilter">
              <mat-option value="">All</mat-option>
              <mat-option value="NEW">NEW</mat-option>
              <mat-option value="PENDING_EXECUTION">PENDING</mat-option>
              <mat-option value="FILLED">FILLED</mat-option>
              <mat-option value="FAILED">FAILED</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Side</mat-label>
            <mat-select [(ngModel)]="sideFilter">
              <mat-option value="">All</mat-option>
              <mat-option value="BUY">BUY</mat-option>
              <mat-option value="SELL">SELL</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-button-toggle-group
            [(ngModel)]="hasDiscrepancyFilter"
            class="discrepancy-toggle">
            <mat-button-toggle [value]="null">All</mat-button-toggle>
            <mat-button-toggle [value]="true">Issues Only</mat-button-toggle>
          </mat-button-toggle-group>

          <button mat-raised-button color="primary" (click)="applyFilters()">
            <mat-icon>search</mat-icon>
            Apply
          </button>

          <button
            mat-stroked-button
            (click)="clearFilters()"
            [disabled]="!hasFilters()">
            <mat-icon>clear</mat-icon>
            Clear
          </button>
        </div>
      </mat-card>

      <!-- Summary Bar -->
      <div class="summary-bar" *ngIf="summary">
        <div class="summary-item">
          <span class="label">Total Orders</span>
          <span class="value">{{ summary.total_orders }}</span>
        </div>
        <div class="summary-item filled">
          <span class="label">Filled</span>
          <span class="value">{{ summary.filled_count }}</span>
        </div>
        <div class="summary-item failed" *ngIf="summary.failed_count > 0">
          <span class="label">Failed</span>
          <span class="value">{{ summary.failed_count }}</span>
        </div>
        <div class="summary-item pending" *ngIf="summary.pending_count > 0">
          <span class="label">Pending</span>
          <span class="value">{{ summary.pending_count }}</span>
        </div>
        <div class="summary-item discrepancy" *ngIf="summary.discrepancy_count > 0">
          <span class="label">Discrepancies</span>
          <span class="value">{{ summary.discrepancy_count }}</span>
        </div>
        <div class="summary-item" *ngIf="summary.avg_fill_rate">
          <span class="label">Avg Fill Rate</span>
          <span class="value">{{ formatPercent(summary.avg_fill_rate) }}</span>
        </div>
      </div>

      <!-- Loading -->
      <div class="loading-container" *ngIf="loading">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Loading audit records...</p>
      </div>

      <!-- Results Table -->
      <div class="table-container" *ngIf="!loading">
        <table mat-table [dataSource]="dataSource" matSort matSortActive="date" matSortDirection="desc" class="audit-table">
          <!-- Date Column -->
          <ng-container matColumnDef="date">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Date</th>
            <td mat-cell *matCellDef="let record">
              <div class="date-cell">
                <span class="date">{{ formatShortDate(record.order.date) }}</span>
                <span class="time" *ngIf="record.order.created_at">
                  {{ formatDateTime(record.order.created_at).split(',')[1] }}
                </span>
              </div>
            </td>
          </ng-container>

          <!-- Symbol Column -->
          <ng-container matColumnDef="symbol">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Symbol</th>
            <td mat-cell *matCellDef="let record">
              <app-symbol-link [symbol]="record.order.symbol"></app-symbol-link>
            </td>
          </ng-container>

          <!-- Side Column -->
          <ng-container matColumnDef="side">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Side</th>
            <td mat-cell *matCellDef="let record">
              <span class="side-badge" [ngClass]="getSideClass(record.order.side)">
                {{ record.order.side }}
              </span>
            </td>
          </ng-container>

          <!-- Qty Column -->
          <ng-container matColumnDef="qty">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Qty</th>
            <td mat-cell *matCellDef="let record">
              <span class="qty">{{ formatQty(record.order.qty) }}</span>
              <span class="filled-qty" *ngIf="record.filled_qty !== record.order.qty">
                ({{ formatQty(record.filled_qty) }} filled)
              </span>
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
            <td mat-cell *matCellDef="let record">
              <span class="status-badge" [ngClass]="getStatusClass(record.order.status)">
                {{ record.order.status }}
              </span>
            </td>
          </ng-container>

          <!-- Fill Rate Column -->
          <ng-container matColumnDef="fillRate">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Fill Rate</th>
            <td mat-cell *matCellDef="let record">
              <span [class.low-fill]="record.fill_rate < 1">
                {{ formatPercent(record.fill_rate) }}
              </span>
            </td>
          </ng-container>

          <!-- Discrepancies Column -->
          <ng-container matColumnDef="discrepancies">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Issues</th>
            <td mat-cell *matCellDef="let record">
              <ng-container *ngIf="getDiscrepancyCount(record) > 0">
                <mat-icon
                  [ngClass]="'issue-' + getDiscrepancySeverity(record)"
                  [matTooltip]="record.discrepancies[0].description">
                  {{ getDiscrepancySeverity(record) === 'error' ? 'error' : 'warning' }}
                </mat-icon>
                <span class="issue-count" *ngIf="getDiscrepancyCount(record) > 1">
                  +{{ getDiscrepancyCount(record) - 1 }}
                </span>
              </ng-container>
              <span *ngIf="getDiscrepancyCount(record) === 0" class="no-issues">-</span>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let record">
              <button mat-icon-button (click)="viewDetails(record); $event.stopPropagation()" matTooltip="View Details">
                <mat-icon>visibility</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: displayedColumns"
            [class.has-issues]="getDiscrepancyCount(row) > 0"
            (click)="viewDetails(row)">
          </tr>
        </table>

        <!-- Empty State -->
        <div *ngIf="records.length === 0" class="empty-state">
          <mat-icon>inbox</mat-icon>
          <p>No order records found for the selected filters.</p>
        </div>

        <!-- Paginator -->
        <mat-paginator
          *ngIf="records.length > 0"
          [length]="totalRecords"
          [pageSize]="pageSize"
          [pageIndex]="pageIndex"
          [pageSizeOptions]="[10, 25, 50, 100]"
          (page)="onPageChange($event)">
        </mat-paginator>
      </div>
    </div>
  </mat-sidenav-content>

  <!-- Detail Drawer -->
  <mat-sidenav
    #drawer
    position="end"
    mode="over"
    [opened]="drawerOpen"
    (closed)="closeDrawer()"
    class="detail-drawer">
    <div class="drawer-content" *ngIf="selectedRecord">
      <!-- Drawer Header -->
      <div class="drawer-header">
        <div class="header-title">
          <h2>Order Audit</h2>
          <span class="order-id">{{ selectedRecord.order.order_id }}</span>
        </div>
        <button mat-icon-button (click)="closeDrawer()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <!-- Order Summary -->
      <div class="order-summary">
        <div class="summary-header">
          <app-symbol-link [symbol]="selectedRecord.order.symbol"></app-symbol-link>
          <span class="side-badge" [ngClass]="getSideClass(selectedRecord.order.side)">
            {{ selectedRecord.order.side }}
          </span>
          <span class="qty">{{ formatQty(selectedRecord.order.qty) }} shares</span>
        </div>
        <div class="summary-stats">
          <div class="stat">
            <span class="label">Status</span>
            <span class="status-badge" [ngClass]="getStatusClass(selectedRecord.order.status)">
              {{ selectedRecord.order.status }}
            </span>
          </div>
          <div class="stat">
            <span class="label">Fill Rate</span>
            <span [class.low-fill]="selectedRecord.fill_rate < 1">
              {{ formatPercent(selectedRecord.fill_rate) }}
            </span>
          </div>
          <div class="stat" *ngIf="selectedRecord.avg_fill_price">
            <span class="label">Avg Price</span>
            <span>{{ formatPrice(selectedRecord.avg_fill_price) }}</span>
          </div>
          <div class="stat">
            <span class="label">Commission</span>
            <span>{{ formatPrice(selectedRecord.total_commission) }}</span>
          </div>
        </div>
      </div>

      <mat-divider></mat-divider>

      <!-- Signal & Target Info -->
      <div class="section" *ngIf="selectedRecord.signal || selectedRecord.target">
        <h3>Decision Context</h3>

        <div class="context-card" *ngIf="selectedRecord.signal">
          <div class="context-label">Signal</div>
          <div class="context-content">
            <span class="direction" [class.long]="selectedRecord.signal.direction === 1"
              [class.short]="selectedRecord.signal.direction === -1">
              {{ selectedRecord.signal.direction === 1 ? 'LONG' : selectedRecord.signal.direction === -1 ? 'SHORT' : 'FLAT' }}
            </span>
            <span class="weight">Weight: {{ formatPercent(selectedRecord.signal.target_weight) }}</span>
          </div>
        </div>

        <div class="context-card" *ngIf="selectedRecord.target">
          <div class="context-label">Target Exposure</div>
          <div class="context-content">
            <span class="exposure">{{ formatPercent(selectedRecord.target.target_exposure) }}</span>
            <span class="capped" *ngIf="selectedRecord.target.is_capped">
              (Capped: {{ selectedRecord.target.reason || 'risk limit' }})
            </span>
          </div>
        </div>
      </div>

      <mat-divider></mat-divider>

      <!-- Discrepancies -->
      <div class="section" *ngIf="selectedRecord.discrepancies.length > 0">
        <h3>Discrepancies</h3>
        <div class="discrepancy-list">
          <div
            *ngFor="let d of selectedRecord.discrepancies"
            class="discrepancy-item"
            [ngClass]="'severity-' + d.severity">
            <mat-icon>{{ d.severity === 'error' ? 'error' : 'warning' }}</mat-icon>
            <div class="discrepancy-content">
              <span class="type">{{ d.type }}</span>
              <span class="desc">{{ d.description }}</span>
            </div>
          </div>
        </div>
      </div>

      <mat-divider></mat-divider>

      <!-- Timeline -->
      <div class="section">
        <h3>Timeline</h3>
        <app-audit-timeline [events]="selectedRecord.timeline"></app-audit-timeline>
      </div>

      <mat-divider></mat-divider>

      <!-- Fills -->
      <div class="section" *ngIf="selectedRecord.fills.length > 0">
        <h3>Fills</h3>
        <div class="fills-list">
          <div *ngFor="let fill of selectedRecord.fills" class="fill-item">
            <span class="fill-qty">{{ formatQty(fill.qty) }}</span>
            <span class="fill-price">@ {{ formatPrice(fill.price) }}</span>
            <span class="fill-exchange" *ngIf="fill.exchange">{{ fill.exchange }}</span>
            <span class="fill-time">{{ formatDateTime(fill.date) }}</span>
          </div>
        </div>
      </div>
    </div>
  </mat-sidenav>
</mat-sidenav-container>
