<div class="health-container space-y-4">
    <h2 class="text-lg font-semibold text-text">System Status</h2>

    <div class="sync-panel flex flex-wrap items-center justify-between gap-4 rounded-md border border-border bg-canvas px-4 py-3 shadow-subtle">
        <div class="sync-text">
            <h3 class="text-base font-semibold text-text">Portfolio Sync</h3>
            <p class="text-sm text-muted">Refresh holdings, orders, fills, and portfolio state from Alpaca.</p>
        </div>
        <button mat-raised-button color="primary" (click)="syncPortfolio()" [disabled]="syncing">
            {{ syncing ? 'Syncing...' : 'Sync Now' }}
        </button>
    </div>
    <p class="status-message text-sm text-muted" *ngIf="syncMessage">{{ syncMessage }}</p>
    <p class="status-message text-sm text-danger" *ngIf="syncError">{{ syncError }}</p>

    <div class="kill-switch-panel flex flex-col gap-3 rounded-md border border-border bg-canvas px-4 py-3 shadow-subtle">
        <div class="flex flex-wrap items-start justify-between gap-4">
            <div class="kill-switch-text">
                <h3 class="text-base font-semibold text-text">Trading Kill Switch</h3>
                <p class="text-sm text-muted">
                    Emergency halt for order generation and broker execution. Auto triggers on daily loss threshold.
                </p>
            </div>
            <div class="kill-switch-status" [class.active]="killSwitchActive" [class.inactive]="!killSwitchActive">
                {{ killSwitchStatusText }}
            </div>
        </div>
        <div class="text-sm text-muted" *ngIf="killSwitchActive">
            <span class="font-semibold text-text">
                {{ killSwitchSource === 'auto' ? 'Auto halt reason:' : 'Reason:' }}
            </span>
            {{ killSwitchReason || 'Reason not recorded.' }}
        </div>
        <div class="flex flex-wrap items-center gap-2">
            <button mat-stroked-button color="warn" (click)="activateKillSwitch()"
                [disabled]="killSwitchBusy || killSwitchActive">
                Halt Trading
            </button>
            <button mat-stroked-button color="primary" (click)="resetKillSwitch()"
                [disabled]="killSwitchBusy || !killSwitchActive">
                Resume Trading
            </button>
            <span class="text-xs text-muted" *ngIf="killSwitchTriggeredAt">
                Triggered {{ killSwitchTriggeredAt | date: 'MMM d, h:mm a' }}
            </span>
        </div>
        <p class="status-message text-sm text-muted" *ngIf="killSwitchMessage">{{ killSwitchMessage }}</p>
        <p class="status-message text-sm text-danger" *ngIf="killSwitchError">{{ killSwitchError }}</p>
    </div>

    <p class="status-message text-sm text-muted" *ngIf="loading">Checking system health...</p>
    <p class="status-message text-sm text-danger" *ngIf="errorMsg">{{ errorMsg }}</p>

    <div class="grid grid-cols-1 gap-4 md:grid-cols-2 xl:grid-cols-3">
        <mat-card *ngFor="let service of services" class="status-card" [class]="service.status">
            <mat-card-header>
                <mat-icon mat-card-avatar *ngIf="service.status === 'healthy'"
                    class="icon-healthy">check_circle</mat-icon>
                <mat-icon mat-card-avatar *ngIf="service.status === 'warning'" class="icon-warning">warning</mat-icon>
                <mat-icon mat-card-avatar *ngIf="service.status === 'error'" class="icon-error">error</mat-icon>
                <mat-card-title>{{ service.name }}</mat-card-title>
                <mat-card-subtitle>{{ service.last_heartbeat }}</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content *ngIf="service.message">
                <p>{{ service.message }}</p>
            </mat-card-content>
        </mat-card>
    </div>
</div>
