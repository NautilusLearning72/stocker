<div class="table-toolbar flex flex-wrap items-center gap-3">
    <mat-form-field appearance="outline" class="search-field w-full sm:flex-1">
        <mat-icon matPrefix>search</mat-icon>
        <input matInput placeholder="Search symbol or name" [(ngModel)]="filterText" (ngModelChange)="applyFilter()" />
    </mat-form-field>

    <mat-form-field appearance="outline" class="side-field w-full sm:w-40">
        <mat-label>Side</mat-label>
        <mat-select [(ngModel)]="sideFilter" (selectionChange)="applyFilter()">
            <mat-option value="ALL">All</mat-option>
            <mat-option value="LONG">Long</mat-option>
            <mat-option value="SHORT">Short</mat-option>
        </mat-select>
    </mat-form-field>

    <button mat-stroked-button type="button" (click)="clearFilters()">Clear</button>
</div>

<table mat-table [dataSource]="dataSource" matSort class="hover-table w-full text-sm">

    <!-- Symbol Column -->
    <ng-container matColumnDef="symbol">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Symbol </th>
        <td mat-cell *matCellDef="let element">
            <app-symbol-link [symbol]="element.symbol"></app-symbol-link>
        </td>
    </ng-container>

    <!-- Name Column -->
    <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Name </th>
        <td mat-cell *matCellDef="let element"> {{instrumentNames[element.symbol] || '—'}} </td>
    </ng-container>

    <!-- Qty Column -->
    <ng-container matColumnDef="qty">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Qty </th>
        <td mat-cell *matCellDef="let element"> {{element.qty | number:'1.0-4'}} </td>
    </ng-container>

    <!-- Side Column -->
    <ng-container matColumnDef="side">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Side </th>
        <td mat-cell *matCellDef="let element"> {{element.side || '—'}} </td>
    </ng-container>

    <!-- Price Column -->
    <ng-container matColumnDef="current_price">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Price </th>
        <td mat-cell *matCellDef="let element">
            {{ element.current_price != null ? (element.current_price | currency) : '—' }}
        </td>
    </ng-container>

    <!-- Market Value Column -->
    <ng-container matColumnDef="market_value">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Market Value </th>
        <td mat-cell *matCellDef="let element">
            {{ element.market_value != null ? (element.market_value | currency) : '—' }}
        </td>
    </ng-container>

    <!-- Avg Entry Column -->
    <ng-container matColumnDef="avg_entry_price">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Avg Entry </th>
        <td mat-cell *matCellDef="let element">
            {{ element.avg_entry_price != null ? (element.avg_entry_price | currency) : '—' }}
        </td>
    </ng-container>

    <!-- Cost Basis Column -->
    <ng-container matColumnDef="cost_basis">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Cost Basis </th>
        <td mat-cell *matCellDef="let element">
            {{ element.cost_basis != null ? (element.cost_basis | currency) : '—' }}
        </td>
    </ng-container>

    <!-- Today's P/L % Column -->
    <ng-container matColumnDef="today_pl_pct">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Today's P/L (%) </th>
        <td mat-cell *matCellDef="let element" [class]="pnlClass(element.unrealized_intraday_plpc)">
            {{ formatPercent(element.unrealized_intraday_plpc ?? null) }}
        </td>
    </ng-container>

    <!-- Today's P/L $ Column -->
    <ng-container matColumnDef="today_pl">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Today's P/L ($) </th>
        <td mat-cell *matCellDef="let element" [class]="pnlClass(element.unrealized_intraday_pl)">
            {{ element.unrealized_intraday_pl != null ? (element.unrealized_intraday_pl | currency) : '—' }}
        </td>
    </ng-container>

    <!-- Total P/L % Column -->
    <ng-container matColumnDef="total_pl_pct">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Total P/L (%) </th>
        <td mat-cell *matCellDef="let element" [class]="pnlClass(element.unrealized_plpc)">
            {{ formatPercent(element.unrealized_plpc ?? null) }}
        </td>
    </ng-container>

    <!-- Total P/L $ Column -->
    <ng-container matColumnDef="total_pl">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Total P/L ($) </th>
        <td mat-cell *matCellDef="let element" [class]="pnlClass(element.unrealized_pl)">
            {{ element.unrealized_pl != null ? (element.unrealized_pl | currency) : '—' }}
        </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
</table>

<div *ngIf="dataSource.filteredData.length === 0" class="no-data mt-3 text-sm text-muted">
    No holdings match your filters
</div>
