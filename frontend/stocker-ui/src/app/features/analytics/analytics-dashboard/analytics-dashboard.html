<mat-sidenav-container class="analytics-container h-full">
  <mat-sidenav-content>
    <div class="analytics-dashboard mx-auto max-w-6xl space-y-4">
      <div class="page-header flex flex-wrap items-center justify-between gap-4">
        <div class="header-title flex items-center gap-3">
          <mat-icon class="text-accent">insights</mat-icon>
          <div>
            <h1 class="text-xl font-semibold text-text">Analytics</h1>
            <div class="text-sm text-muted">
              Explore derived metrics, rule-based scoring, and ranked opportunities.
            </div>
          </div>
        </div>

        <div class="header-actions flex items-center gap-2">
          <div class="status-pill" *ngIf="metricsStatus">
            <mat-icon>schedule</mat-icon>
            <span>Scores: {{ formatStatusDate(metricsStatus.latest_scores_date) }}</span>
          </div>
          <div class="status-pill" *ngIf="metricsStatus">
            <mat-icon>timeline</mat-icon>
            <span>Values: {{ formatStatusDate(metricsStatus.latest_values_date) }}</span>
          </div>
          <button mat-stroked-button (click)="toggleDrawer()">
            <mat-icon>tune</mat-icon>
            Rule Sets
          </button>
          <button mat-icon-button (click)="refresh()" [disabled]="loadingScores">
            <mat-icon [class.spinning]="loadingScores">refresh</mat-icon>
          </button>
        </div>
      </div>

      <mat-card class="controls-card">
        <div class="controls-row flex flex-wrap items-center gap-3">
          <mat-form-field appearance="outline" class="control-field w-full sm:w-48">
            <mat-label>Rule Set</mat-label>
            <mat-select [(ngModel)]="selectedRuleSetId" (selectionChange)="onRuleSetSelectionChange()">
              <mat-option *ngFor="let rs of ruleSets" [value]="rs.id">
                {{ rs.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="control-field w-full sm:w-36">
            <mat-label>As Of Date</mat-label>
            <input matInput [matDatepicker]="asOfPicker" [(ngModel)]="asOfDate">
            <mat-datepicker-toggle matIconSuffix [for]="asOfPicker"></mat-datepicker-toggle>
            <mat-datepicker #asOfPicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline" class="control-field w-full sm:w-40">
            <mat-label>Search</mat-label>
            <input matInput [(ngModel)]="search" placeholder="Symbol or text">
          </mat-form-field>

          <mat-form-field appearance="outline" class="control-field w-full sm:w-36">
            <mat-label>Sector</mat-label>
            <input matInput [(ngModel)]="sector" placeholder="Technology">
          </mat-form-field>

          <mat-form-field appearance="outline" class="control-field w-full sm:w-36">
            <mat-label>Industry</mat-label>
            <input matInput [(ngModel)]="industry" placeholder="Software">
          </mat-form-field>

          <mat-form-field appearance="outline" class="control-field w-full sm:w-28">
            <mat-label>Min Score</mat-label>
            <input matInput type="number" [(ngModel)]="minScore">
          </mat-form-field>

          <mat-form-field appearance="outline" class="control-field w-full sm:w-28">
            <mat-label>Max Score</mat-label>
            <input matInput type="number" [(ngModel)]="maxScore">
          </mat-form-field>

          <mat-form-field appearance="outline" class="control-field w-full sm:w-48">
            <mat-label>Universe</mat-label>
            <mat-select [(ngModel)]="universeId">
              <mat-option [value]="null">All universes</mat-option>
              <mat-option *ngFor="let universe of universes" [value]="universe.id">
                {{ universe.name }} <span *ngIf="universe.is_global">(Global)</span>
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="control-field w-full sm:w-60">
            <mat-label>Columns</mat-label>
            <mat-select multiple [(ngModel)]="selectedMetricKeys" (selectionChange)="onColumnsChange()">
              <mat-optgroup *ngFor="let category of categories" [label]="category">
                <mat-option *ngFor="let def of definitionsByCategory[category]" [value]="def.metric_key">
                  {{ def.name }} ({{ def.metric_key }})
                </mat-option>
              </mat-optgroup>
            </mat-select>
          </mat-form-field>

          <button mat-raised-button color="primary" (click)="applyFilters()">
            <mat-icon>search</mat-icon>
            Apply
          </button>

          <button mat-stroked-button (click)="clearFilters()">
            <mat-icon>clear</mat-icon>
            Clear
          </button>
        </div>
      </mat-card>

      <mat-card class="filters-card">
        <div class="filters-row flex flex-wrap items-center gap-3">
          <mat-form-field appearance="outline" class="control-field w-full sm:w-60">
            <mat-label>Metric Filter</mat-label>
            <mat-select [(ngModel)]="filterMetricKey">
              <mat-option *ngFor="let def of definitions" [value]="def.metric_key">
                {{ def.name }} ({{ def.metric_key }})
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="control-field w-full sm:w-24">
            <mat-label>Op</mat-label>
            <mat-select [(ngModel)]="filterOperator">
              <mat-option *ngFor="let op of operators" [value]="op">{{ op }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="control-field w-full sm:w-28">
            <mat-label>Value</mat-label>
            <input matInput type="number" [(ngModel)]="filterValue">
          </mat-form-field>

          <button mat-stroked-button (click)="addMetricFilter()">
            <mat-icon>add</mat-icon>
            Add Filter
          </button>
        </div>

        <div class="filter-chips mt-3 flex flex-wrap gap-2" *ngIf="metricFilters.length">
          <mat-chip *ngFor="let filter of metricFilters; let i = index" (removed)="removeMetricFilter(i)">
            {{ filter.metric_key }} {{ filter.op }} {{ filter.value }}
            <button matChipRemove>
              <mat-icon>close</mat-icon>
            </button>
          </mat-chip>
        </div>
      </mat-card>

      <div class="error-banner" *ngIf="errorMessage">
        {{ errorMessage }}
      </div>

      <details class="debug-panel">
        <summary>Debug</summary>
        <div class="debug-grid">
          <div>
            <span class="label">Definitions</span>
            <span class="value">{{ definitions.length }}</span>
          </div>
          <div>
            <span class="label">Rule Sets</span>
            <span class="value">{{ ruleSets.length }}</span>
          </div>
          <div>
            <span class="label">Rules</span>
            <span class="value">{{ rules.length }}</span>
          </div>
          <div>
            <span class="label">Selected Rule Set</span>
            <span class="value">{{ selectedRuleSetId || 'None' }}</span>
          </div>
          <div>
            <span class="label">Universe Filter</span>
            <span class="value">{{ getUniverseLabel(universeId) }}</span>
          </div>
          <div>
            <span class="label">As Of Date</span>
            <span class="value">{{ asOfDate ? (asOfDate | date:'yyyy-MM-dd') : 'Latest' }}</span>
          </div>
          <div>
            <span class="label">Search</span>
            <span class="value">{{ search || '—' }}</span>
          </div>
          <div>
            <span class="label">Filters</span>
            <span class="value">{{ metricFilters.length }}</span>
          </div>
          <div>
            <span class="label">Sort</span>
            <span class="value">{{ sortField }} ({{ sortOrder }})</span>
          </div>
          <div>
            <span class="label">Columns</span>
            <span class="value">{{ selectedMetricKeys.length }}</span>
          </div>
          <div>
            <span class="label">Results</span>
            <span class="value">{{ total }}</span>
          </div>
          <div>
            <span class="label">Scores Date</span>
            <span class="value">{{ formatStatusDate(metricsStatus?.latest_scores_date) }}</span>
          </div>
          <div>
            <span class="label">Values Date</span>
            <span class="value">{{ formatStatusDate(metricsStatus?.latest_values_date) }}</span>
          </div>
          <div>
            <span class="label">Request Mode</span>
            <span class="value">{{ lastScoresRequest?.mode || '—' }}</span>
          </div>
        </div>
        <pre class="debug-json" *ngIf="lastScoresRequest">{{ lastScoresRequest | json }}</pre>
      </details>

      <div class="table-container overflow-hidden rounded-md border border-border bg-canvas">
        <div class="loading-overlay" *ngIf="loadingScores">
          <mat-spinner diameter="36"></mat-spinner>
          <p>Loading analytics...</p>
        </div>

        <table
          mat-table
          [dataSource]="scores"
          matSort
          [matSortActive]="getSortActive()"
          [matSortDirection]="sortOrder"
          (matSortChange)="onSortChange($event)"
          class="analytics-table w-full">

          <ng-container matColumnDef="symbol">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Symbol</th>
            <td mat-cell *matCellDef="let row">
              <app-symbol-link [symbol]="row.symbol"></app-symbol-link>
            </td>
          </ng-container>

          <ng-container matColumnDef="score">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Score</th>
            <td mat-cell *matCellDef="let row">{{ formatScore(row.score) }}</td>
          </ng-container>

          <ng-container matColumnDef="rank">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Rank</th>
            <td mat-cell *matCellDef="let row">{{ row.rank ?? '—' }}</td>
          </ng-container>

          <ng-container matColumnDef="percentile">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Percentile</th>
            <td mat-cell *matCellDef="let row">{{ formatPercent(row.percentile) }}</td>
          </ng-container>

          <ng-container matColumnDef="sector">
            <th mat-header-cell *matHeaderCellDef>Sector</th>
            <td mat-cell *matCellDef="let row">{{ getSector(row.symbol) }}</td>
          </ng-container>

          <ng-container matColumnDef="last_price">
            <th mat-header-cell *matHeaderCellDef>Last Price</th>
            <td mat-cell *matCellDef="let row">
              <span *ngIf="getLastPrice(row.symbol) as price">{{ price | currency:'USD':'symbol':'1.2-2' }}</span>
              <span *ngIf="!getLastPrice(row.symbol)">—</span>
            </td>
          </ng-container>

          <ng-container matColumnDef="holding">
            <th mat-header-cell *matHeaderCellDef>Holding</th>
            <td mat-cell *matCellDef="let row">
              <ng-container *ngIf="getHolding(row.symbol) as holding; else noHolding">
                <div class="holding-cell">
                  <span class="qty">{{ holding.qty | number:'1.0-2' }}</span>
                  <span class="value">{{ holding.market_value | currency:'USD':'symbol':'1.0-0' }}</span>
                </div>
              </ng-container>
              <ng-template #noHolding>—</ng-template>
            </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Action</th>
            <td mat-cell *matCellDef="let row">
              <button mat-stroked-button (click)="openOrderDialog(row, $event)">
                Trade
              </button>
            </td>
          </ng-container>

          <ng-container *ngFor="let metricKey of selectedMetricKeys" [matColumnDef]="metricKey">
            <th
              mat-header-cell
              *matHeaderCellDef
              mat-sort-header
              [matTooltip]="metricTooltip(metricKey)">
              <div class="metric-header">
                <span class="metric-name">{{ definitionByKey[metricKey]?.name || metricKey }}</span>
                <span class="metric-key text-xs text-muted">{{ metricKey }}</span>
              </div>
            </th>
            <td mat-cell *matCellDef="let row">
              {{ formatMetricValue(row.metrics[metricKey], metricKey) }}
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: displayedColumns"
            (click)="onRowClick(row)"
            class="analytics-row">
          </tr>
        </table>

        <div class="empty-state flex flex-col items-center justify-center gap-2 p-6 text-muted" *ngIf="!loadingScores && scores.length === 0">
          <mat-icon>search_off</mat-icon>
          <div>No results found for the current filters.</div>
        </div>
      </div>

      <div class="status-bar flex flex-wrap items-center justify-between gap-3 rounded-md border border-border bg-canvas-subtle px-4 py-3 text-sm">
        <div>
          <span class="text-muted">Total Symbols:</span>
          <span class="ml-2 text-text">{{ total }}</span>
        </div>
        <div>
          <span class="text-muted">Page:</span>
          <span class="ml-2 text-text">{{ page }}</span>
        </div>
        <div>
          <span class="text-muted">As Of:</span>
          <span class="ml-2 text-text">{{ asOfDate ? (asOfDate | date:'yyyy-MM-dd') : 'Latest' }}</span>
        </div>
      </div>

      <mat-paginator
        [length]="total"
        [pageIndex]="page - 1"
        [pageSize]="pageSize"
        [pageSizeOptions]="pageSizeOptions"
        (page)="onPageChange($event)">
      </mat-paginator>
    </div>
  </mat-sidenav-content>

  <mat-sidenav position="end" mode="over" [(opened)]="drawerOpen" class="rule-drawer">
    <div class="drawer-header">
      <h2 class="text-lg font-semibold text-text">Rule Sets</h2>
      <button mat-icon-button (click)="toggleDrawer()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="drawer-body">
      <div class="section">
        <h3 class="section-title">Create Rule Set</h3>
        <mat-form-field appearance="outline" class="drawer-field">
          <mat-label>Name</mat-label>
          <input matInput [(ngModel)]="newRuleSet.name" placeholder="Quality + Momentum">
        </mat-form-field>
        <mat-form-field appearance="outline" class="drawer-field">
          <mat-label>Description</mat-label>
          <textarea matInput rows="2" [(ngModel)]="newRuleSet.description"></textarea>
        </mat-form-field>
        <mat-form-field appearance="outline" class="drawer-field">
          <mat-label>Universe</mat-label>
          <mat-select [(ngModel)]="newRuleSet.universe_id">
            <mat-option [value]="null">All universes</mat-option>
            <mat-option *ngFor="let universe of universes" [value]="universe.id">
              {{ universe.name }} <span *ngIf="universe.is_global">(Global)</span>
            </mat-option>
          </mat-select>
        </mat-form-field>
        <mat-checkbox [(ngModel)]="newRuleSet.is_active">Active</mat-checkbox>
        <div class="drawer-actions">
          <button mat-raised-button color="primary" (click)="createRuleSet()">Create</button>
        </div>
      </div>

      <mat-divider></mat-divider>

      <div class="section">
        <h3 class="section-title">Existing Rule Sets</h3>
        <div class="rule-set-list">
          <button
            mat-stroked-button
            *ngFor="let rs of ruleSets"
            [class.active]="rs.id === selectedRuleSetId"
            (click)="selectedRuleSetId = rs.id; onRuleSetSelectionChange()">
            {{ rs.name }}
          </button>
        </div>
      </div>

      <div class="section" *ngIf="ruleSetDraft">
        <h3 class="section-title">Edit Rule Set</h3>
        <mat-form-field appearance="outline" class="drawer-field">
          <mat-label>Name</mat-label>
          <input matInput [(ngModel)]="ruleSetDraft.name">
        </mat-form-field>
        <mat-form-field appearance="outline" class="drawer-field">
          <mat-label>Description</mat-label>
          <textarea matInput rows="2" [(ngModel)]="ruleSetDraft.description"></textarea>
        </mat-form-field>
        <mat-form-field appearance="outline" class="drawer-field">
          <mat-label>Universe</mat-label>
          <mat-select [(ngModel)]="ruleSetDraft.universe_id">
            <mat-option [value]="null">All universes</mat-option>
            <mat-option *ngFor="let universe of universes" [value]="universe.id">
              {{ universe.name }} <span *ngIf="universe.is_global">(Global)</span>
            </mat-option>
          </mat-select>
        </mat-form-field>
        <mat-checkbox [(ngModel)]="ruleSetDraft.is_active">Active</mat-checkbox>
        <div class="drawer-actions">
          <button mat-raised-button color="primary" (click)="saveRuleSet()">Save</button>
          <button mat-stroked-button (click)="duplicateRuleSet()">Duplicate</button>
          <button mat-stroked-button color="warn" (click)="deleteRuleSet()">Delete</button>
        </div>
      </div>

      <mat-divider></mat-divider>

      <div class="section" *ngIf="ruleSetDraft">
        <h3 class="section-title">Rules</h3>
        <div class="rule-row" *ngFor="let rule of rules">
          <mat-form-field appearance="outline" class="drawer-field">
            <mat-label>Metric</mat-label>
            <mat-select [(ngModel)]="rule.metric_key">
              <mat-option *ngFor="let def of definitions" [value]="def.metric_key">
                {{ def.name }} ({{ def.metric_key }})
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="drawer-field">
            <mat-label>Operator</mat-label>
            <mat-select [(ngModel)]="rule.operator">
              <mat-option *ngFor="let op of operators" [value]="op">{{ op }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="drawer-field">
            <mat-label>Low</mat-label>
            <input matInput type="number" [(ngModel)]="rule.threshold_low">
          </mat-form-field>

          <mat-form-field appearance="outline" class="drawer-field">
            <mat-label>High</mat-label>
            <input matInput type="number" [(ngModel)]="rule.threshold_high">
          </mat-form-field>

          <mat-form-field appearance="outline" class="drawer-field">
            <mat-label>Weight</mat-label>
            <input matInput type="number" [(ngModel)]="rule.weight">
          </mat-form-field>

          <mat-form-field appearance="outline" class="drawer-field">
            <mat-label>Normalize</mat-label>
            <mat-select [(ngModel)]="rule.normalize_display">
              <mat-option *ngFor="let opt of normalizeOptions" [value]="opt">{{ opt }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-checkbox [(ngModel)]="rule.is_required">Required</mat-checkbox>
          <div class="rule-actions">
            <button mat-icon-button (click)="saveRule(rule)">
              <mat-icon>save</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="deleteRule(rule.id)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>

        <div class="rule-row new-rule">
          <mat-form-field appearance="outline" class="drawer-field">
            <mat-label>Metric</mat-label>
            <mat-select [(ngModel)]="newRule.metric_key">
              <mat-option *ngFor="let def of definitions" [value]="def.metric_key">
                {{ def.name }} ({{ def.metric_key }})
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="drawer-field">
            <mat-label>Operator</mat-label>
            <mat-select [(ngModel)]="newRule.operator">
              <mat-option *ngFor="let op of operators" [value]="op">{{ op }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="drawer-field">
            <mat-label>Low</mat-label>
            <input matInput type="number" [(ngModel)]="newRule.threshold_low">
          </mat-form-field>

          <mat-form-field appearance="outline" class="drawer-field">
            <mat-label>High</mat-label>
            <input matInput type="number" [(ngModel)]="newRule.threshold_high">
          </mat-form-field>

          <mat-form-field appearance="outline" class="drawer-field">
            <mat-label>Weight</mat-label>
            <input matInput type="number" [(ngModel)]="newRule.weight">
          </mat-form-field>

          <mat-form-field appearance="outline" class="drawer-field">
            <mat-label>Normalize</mat-label>
            <mat-select [(ngModel)]="newRule.normalize_display">
              <mat-option *ngFor="let opt of normalizeOptions" [value]="opt">{{ opt }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-checkbox [(ngModel)]="newRule.is_required">Required</mat-checkbox>
          <div class="rule-actions">
            <button mat-raised-button color="primary" (click)="addRule()">Add Rule</button>
          </div>
        </div>
      </div>

      <div class="drawer-error" *ngIf="drawerError">{{ drawerError }}</div>
    </div>
  </mat-sidenav>
</mat-sidenav-container>
