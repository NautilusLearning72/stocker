<div class="event-feed">
  <!-- Filter Bar -->
  <div class="filter-bar">
    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Category</mat-label>
      <mat-select [(ngModel)]="selectedCategory" (selectionChange)="onCategoryChange()">
        <mat-option value="">All Categories</mat-option>
        <mat-option *ngFor="let cat of getCategoryKeys()" [value]="cat">
          {{ cat }}
        </mat-option>
      </mat-select>
      <mat-hint *ngIf="selectedCategory">{{ getCategoryDescription(selectedCategory) }}</mat-hint>
    </mat-form-field>

    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Event Type</mat-label>
      <mat-select
        [(ngModel)]="selectedEventType"
        (selectionChange)="onEventTypeChange()"
        [disabled]="!selectedCategory">
        <mat-option value="">All Types</mat-option>
        <mat-option *ngFor="let type of eventTypeOptions" [value]="type">
          {{ type }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="filter-field symbol-field">
      <mat-label>Symbol</mat-label>
      <input
        matInput
        [(ngModel)]="symbolFilter"
        (change)="onSymbolFilterChange()"
        placeholder="e.g., AAPL">
    </mat-form-field>

    <button
      mat-stroked-button
      (click)="clearFilters()"
      [disabled]="!selectedCategory && !selectedEventType && !symbolFilter"
      class="clear-btn">
      <mat-icon>clear</mat-icon>
      Clear
    </button>
  </div>

  <!-- Live Indicator -->
  <div *ngIf="isLive" class="live-indicator">
    <span class="pulse"></span>
    <span>Live - New events appear automatically</span>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner diameter="40"></mat-spinner>
    <p>Loading events...</p>
  </div>

  <!-- Events Table -->
  <div class="table-container" *ngIf="!loading">
    <table mat-table [dataSource]="events" class="events-table">

      <!-- Timestamp Column -->
      <ng-container matColumnDef="timestamp">
        <th mat-header-cell *matHeaderCellDef>Time</th>
        <td mat-cell *matCellDef="let event">
          <div class="timestamp-cell">
            <span class="time">{{ formatTimestamp(event.timestamp) }}</span>
            <span class="date">{{ formatDate(event.timestamp) }}</span>
          </div>
        </td>
      </ng-container>

      <!-- Category Column -->
      <ng-container matColumnDef="category">
        <th mat-header-cell *matHeaderCellDef>Category</th>
        <td mat-cell *matCellDef="let event">
          <span class="category-badge" [ngClass]="getCategoryClass(event.category)">
            {{ event.category }}
          </span>
        </td>
      </ng-container>

      <!-- Event Type Column -->
      <ng-container matColumnDef="event_type">
        <th mat-header-cell *matHeaderCellDef>Event</th>
        <td mat-cell *matCellDef="let event">
          <span
            class="event-type"
            [matTooltip]="getEventDescription(event.event_type)"
            matTooltipPosition="above">
            {{ event.event_type }}
          </span>
        </td>
      </ng-container>

      <!-- Symbol Column -->
      <ng-container matColumnDef="symbol">
        <th mat-header-cell *matHeaderCellDef>Symbol</th>
        <td mat-cell *matCellDef="let event">
          <span class="symbol">{{ event.symbol || '-' }}</span>
        </td>
      </ng-container>

      <!-- Value Column -->
      <ng-container matColumnDef="value">
        <th mat-header-cell *matHeaderCellDef>Value</th>
        <td mat-cell *matCellDef="let event">{{ formatValue(event.value) }}</td>
      </ng-container>

      <!-- Details Column -->
      <ng-container matColumnDef="details">
        <th mat-header-cell *matHeaderCellDef>Details</th>
        <td mat-cell *matCellDef="let event" class="details-cell">
          <span
            [matTooltip]="getFullMetadata(event.metadata)"
            matTooltipClass="metadata-tooltip">
            {{ formatMetadata(event.metadata) }}
          </span>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns; let i = index"
          [class.new-event]="isLive && i === 0"></tr>
    </table>

    <!-- Empty State -->
    <div *ngIf="events.length === 0" class="empty-state">
      <mat-icon>inbox</mat-icon>
      <p>No events found for the selected filters.</p>
    </div>
  </div>
</div>
