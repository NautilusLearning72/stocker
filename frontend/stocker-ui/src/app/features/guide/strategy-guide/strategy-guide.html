<div class="guide-container">
    <h1>Strategy Guide</h1>
    <p class="subtitle">Volatility-Targeted Trend-Following System</p>

    <mat-accordion multi>
        <!-- Strategy Overview -->
        <mat-expansion-panel expanded>
            <mat-expansion-panel-header>
                <mat-panel-title>
                    <mat-icon>info</mat-icon>
                    Strategy Overview
                </mat-panel-title>
            </mat-expansion-panel-header>

            <div class="section-content">
                <p>
                    This is a <strong>systematic, trend-following strategy</strong> designed for production-grade
                    reliability. It trades a small universe of liquid instruments (5-8 assets) using daily bars.
                </p>

                <h4>Philosophy</h4>
                <ul>
                    <li>Simple, robust rules that can be backtested properly</li>
                    <li>Minimize dependence on speed or exotic data</li>
                    <li>Risk-first approach with multiple safety layers</li>
                    <li>Paper trade first, then graduate to small live size</li>
                </ul>

                <h4>Default Universe (ETFs)</h4>
                <ul>
                    <li><strong>SPY</strong> - US Equities</li>
                    <li><strong>TLT</strong> - US Treasuries (Long Duration)</li>
                    <li><strong>GLD</strong> - Gold</li>
                    <li><strong>DBC</strong> - Broad Commodities</li>
                    <li><strong>UUP</strong> - USD Index (Optional)</li>
                </ul>
            </div>
        </mat-expansion-panel>

        <!-- Pipeline Architecture -->
        <mat-expansion-panel>
            <mat-expansion-panel-header>
                <mat-panel-title>
                    <mat-icon>account_tree</mat-icon>
                    Pipeline Architecture
                </mat-panel-title>
            </mat-expansion-panel-header>

            <div class="section-content">
                <p>
                    The trading system uses an <strong>event-driven architecture</strong> with Redis Streams
                    connecting specialized consumers in a directed acyclic graph (DAG).
                </p>

                <h4>Data Flow</h4>
                <div class="dag-container">
<pre class="dag-ascii">
┌────────────────────────────────────────────────────────────────┐
│                   STOCKER PIPELINE ARCHITECTURE                │
└────────────────────────────────────────────────────────────────┘

                    ┌──────────────────────┐
                    │   Market Data Task   │
                    │ (ingest_market_data) │
                    └──────────┬───────────┘
                               │
                               ▼
                    ┌──────────────────────┐
                    │   market-bars stream │  ← Redis Stream
                    └──────────┬───────────┘
                               │
                               ▼
                    ┌──────────────────────┐
                    │   Signal Consumer    │
                    │  (TSMOM + EWMA vol)  │
                    └──────────┬───────────┘
                               │
                               ▼
                    ┌──────────────────────┐
                    │    signals stream    │  ← Redis Stream
                    └──────────┬───────────┘
                               │
                               ▼
                    ┌──────────────────────┐
                    │  Portfolio Consumer  │
                    │  (optimizer + caps)  │
                    └──────────┬───────────┘
                               │
                               ▼
                    ┌──────────────────────┐
                    │    targets stream    │  ← Redis Stream
                    └──────────┬───────────┘
                               │
                               ▼
                    ┌──────────────────────┐
                    │    Order Consumer    │
                    │ (diff current vs     │
                    │  target positions)   │
                    └──────────┬───────────┘
                               │
                               ▼
                    ┌──────────────────────┐
                    │    orders stream     │  ← Redis Stream
                    └──────────┬───────────┘
                               │
                               ▼
                    ┌──────────────────────┐
                    │   Broker Consumer    │
                    │  (Alpaca execution)  │
                    └──────────┬───────────┘
                               │
                               ▼
                    ┌──────────────────────┐
                    │     fills stream     │  ← Redis Stream
                    └──────────┬───────────┘
                               │
                               ▼
                    ┌──────────────────────┐
                    │   Ledger Consumer    │
                    │  (Holdings + Cash)   │
                    └──────────┬───────────┘
                               │
                               ▼
                    ┌──────────────────────┐
                    │   Database Updates   │
                    │ (portfolio_state,    │
                    │  holdings, orders)   │
                    └──────────────────────┘
</pre>
                </div>

                <h4>Consumer Details</h4>
                <table class="consumer-table">
                    <thead>
                        <tr>
                            <th>Consumer</th>
                            <th>Listens To</th>
                            <th>Publishes To</th>
                            <th>Function</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Signal</strong></td>
                            <td><code>market-bars</code></td>
                            <td><code>signals</code></td>
                            <td>Computes TSMOM direction + EWMA vol → target weights</td>
                        </tr>
                        <tr>
                            <td><strong>Portfolio</strong></td>
                            <td><code>signals</code></td>
                            <td><code>targets</code></td>
                            <td>Applies caps (35% single, 150% gross), drawdown scaling</td>
                        </tr>
                        <tr>
                            <td><strong>Order</strong></td>
                            <td><code>targets</code></td>
                            <td><code>orders</code></td>
                            <td>Diffs target vs current holdings → generates orders</td>
                        </tr>
                        <tr>
                            <td><strong>Broker</strong></td>
                            <td><code>orders</code></td>
                            <td><code>fills</code></td>
                            <td>Submits to Alpaca API → captures execution</td>
                        </tr>
                        <tr>
                            <td><strong>Ledger</strong></td>
                            <td><code>fills</code></td>
                            <td>(database)</td>
                            <td>Updates holdings, cash, portfolio state</td>
                        </tr>
                        <tr>
                            <td><strong>Monitor</strong></td>
                            <td><code>portfolio-state</code></td>
                            <td><code>alerts</code></td>
                            <td>Kill switch (-3% P&L), drawdown alerts</td>
                        </tr>
                    </tbody>
                </table>

                <h4>Execution Trigger</h4>
                <p>
                    The full pipeline is triggered by <code>run_pipeline.sh</code>, which:
                </p>
                <ol>
                    <li>Starts all stream consumers (Signal, Portfolio, Order, Broker, Ledger)</li>
                    <li>Runs the <code>ingest_market_data()</code> task</li>
                    <li>Market data task publishes to <code>market-bars</code> stream</li>
                    <li>Each consumer processes events and publishes downstream</li>
                    <li>Orders are generated automatically from signal → target → order flow</li>
                </ol>
            </div>
        </mat-expansion-panel>

        <!-- Signal Calculation -->
        <mat-expansion-panel>
            <mat-expansion-panel-header>
                <mat-panel-title>
                    <mat-icon>trending_up</mat-icon>
                    Signal Calculation (TSMOM)
                </mat-panel-title>
            </mat-expansion-panel-header>

            <div class="section-content">
                <p>
                    The strategy uses <strong>Time-Series Momentum (TSMOM)</strong> to determine direction.
                    Each instrument is evaluated independently based on its own price history.
                </p>

                <h4>Lookback Return</h4>
                <p>Calculate the return over the lookback period:</p>
                <div class="formula">
                    R = (P<sub>today</sub> / P<sub>today - 126</sub>) - 1
                </div>

                <h4>Direction Signal</h4>
                <p>Convert return to direction:</p>
                <div class="formula">
                    direction = +1 if R > 0 (LONG)<br>
                    direction = -1 if R < 0 (SHORT)
                </div>

                <h4>Interpretation</h4>
                <ul>
                    <li><strong>126 days</strong> = approximately 6 months of trading days</li>
                    <li>If price is higher than 6 months ago, go long (trend is up)</li>
                    <li>If price is lower than 6 months ago, go short (trend is down)</li>
                    <li>No signal strength - just direction (binary)</li>
                </ul>
            </div>
        </mat-expansion-panel>

        <!-- Trend Confirmation -->
        <mat-expansion-panel>
            <mat-expansion-panel-header>
                <mat-panel-title>
                    <mat-icon>verified</mat-icon>
                    Trend Confirmation (Optional)
                </mat-panel-title>
            </mat-expansion-panel-header>

            <div class="section-content">
                <p>
                    <strong>Optional filters</strong> to reduce false signals in choppy or ranging markets.
                    When enabled, the momentum signal must be confirmed before taking a position.
                </p>

                <div class="limit-card">
                    <strong>Status: Disabled by Default</strong>
                    <p>Set <code>CONFIRMATION_ENABLED=true</code> to activate.</p>
                </div>

                <h4>Donchian Breakout Confirmation</h4>
                <p>Price must break the N-day channel to confirm the trend:</p>
                <ul>
                    <li><strong>Long Signal:</strong> Current price >= 20-day high</li>
                    <li><strong>Short Signal:</strong> Current price <= 20-day low</li>
                </ul>
                <div class="formula">
                    For longs: P<sub>current</sub> >= max(P<sub>t-1</sub>, ..., P<sub>t-20</sub>)
                </div>

                <h4>Dual Moving Average Confirmation</h4>
                <p>Fast and slow moving averages must align with trend direction:</p>
                <ul>
                    <li><strong>Long Signal:</strong> 50-day MA > 200-day MA</li>
                    <li><strong>Short Signal:</strong> 50-day MA < 200-day MA</li>
                </ul>

                <h4>Confirmation Types</h4>
                <table class="example-table">
                    <tr>
                        <th>Type</th>
                        <th>Requirement</th>
                    </tr>
                    <tr>
                        <td><code>donchian</code></td>
                        <td>Price breakout only (default)</td>
                    </tr>
                    <tr>
                        <td><code>dual_ma</code></td>
                        <td>MA cross only</td>
                    </tr>
                    <tr>
                        <td><code>both</code></td>
                        <td>Both must confirm (most conservative)</td>
                    </tr>
                </table>
            </div>
        </mat-expansion-panel>

        <!-- Volatility Estimation -->
        <mat-expansion-panel>
            <mat-expansion-panel-header>
                <mat-panel-title>
                    <mat-icon>show_chart</mat-icon>
                    Volatility Estimation (EWMA)
                </mat-panel-title>
            </mat-expansion-panel-header>

            <div class="section-content">
                <p>
                    Volatility is estimated using <strong>Exponentially Weighted Moving Average (EWMA)</strong>,
                    following the RiskMetrics methodology.
                </p>

                <h4>Daily Log Returns</h4>
                <div class="formula">
                    r<sub>t</sub> = ln(P<sub>t</sub> / P<sub>t-1</sub>)
                </div>

                <h4>EWMA Variance</h4>
                <p>Recursive calculation with exponential decay:</p>
                <div class="formula">
                    &sigma;&sup2;<sub>t</sub> = &lambda; &times; &sigma;&sup2;<sub>t-1</sub> + (1 - &lambda;) &times; r<sub>t</sub>&sup2;
                </div>

                <h4>Annualization</h4>
                <div class="formula">
                    &sigma;<sub>annual</sub> = &sigma;<sub>daily</sub> &times; &radic;252
                </div>

                <h4>Lambda Parameter (&lambda; = 0.94)</h4>
                <ul>
                    <li>Higher lambda = more weight on recent variance history</li>
                    <li>0.94 is the RiskMetrics standard for daily data</li>
                    <li>Half-life of approximately 11 days</li>
                    <li>Responsive to regime changes while avoiding noise</li>
                </ul>
            </div>
        </mat-expansion-panel>

        <!-- Position Sizing -->
        <mat-expansion-panel>
            <mat-expansion-panel-header>
                <mat-panel-title>
                    <mat-icon>account_balance</mat-icon>
                    Position Sizing
                </mat-panel-title>
            </mat-expansion-panel-header>

            <div class="section-content">
                <p>
                    Positions are sized using <strong>inverse-volatility weighting</strong> to equalize
                    risk contribution across assets.
                </p>

                <h4>Raw Weight Calculation</h4>
                <div class="formula">
                    weight = (target_vol / realized_vol) &times; direction
                </div>

                <h4>Inverse-Volatility Concept</h4>
                <ul>
                    <li>Higher volatility assets get <strong>smaller</strong> positions</li>
                    <li>Lower volatility assets get <strong>larger</strong> positions</li>
                    <li>Aims to equalize risk contribution from each asset</li>
                </ul>

                <h4>Example</h4>
                <p>With 10% target volatility:</p>
                <table class="example-table">
                    <tr>
                        <th>Asset</th>
                        <th>Realized Vol</th>
                        <th>Raw Weight</th>
                    </tr>
                    <tr>
                        <td>SPY (20% vol)</td>
                        <td>20%</td>
                        <td>10%/20% = 0.50</td>
                    </tr>
                    <tr>
                        <td>TLT (8% vol)</td>
                        <td>8%</td>
                        <td>10%/8% = 1.25</td>
                    </tr>
                    <tr>
                        <td>GLD (15% vol)</td>
                        <td>15%</td>
                        <td>10%/15% = 0.67</td>
                    </tr>
                </table>
            </div>
        </mat-expansion-panel>

        <!-- Risk Limits -->
        <mat-expansion-panel>
            <mat-expansion-panel-header>
                <mat-panel-title>
                    <mat-icon>security</mat-icon>
                    Risk Limits
                </mat-panel-title>
            </mat-expansion-panel-header>

            <div class="section-content">
                <p>
                    Multiple layers of risk controls protect against concentration and drawdowns.
                </p>

                <h4>Position Limits</h4>
                <div class="limit-card">
                    <strong>Single Instrument Cap: 35%</strong>
                    <p>No single position can exceed 35% of portfolio, regardless of signal strength.</p>
                </div>

                <div class="limit-card">
                    <strong>Gross Exposure Cap: 150%</strong>
                    <p>Sum of absolute exposures cannot exceed 150%. Prevents excessive leverage.</p>
                </div>

                <h4>Drawdown Circuit Breaker</h4>
                <div class="limit-card warning">
                    <strong>Trigger: 10% drawdown from peak</strong>
                    <p>When portfolio drops 10% from high-water mark, all positions are scaled to 50%.</p>
                    <p>Remains active until recovery above the 10% threshold.</p>
                </div>

                <h4>Kill Switch</h4>
                <div class="limit-card error">
                    <strong>Trigger: -3% daily P&L</strong>
                    <p>If daily loss exceeds 3%, immediately:</p>
                    <ul>
                        <li>Cancel all pending orders</li>
                        <li>Halt trading</li>
                        <li>Require manual reset to resume</li>
                    </ul>
                </div>
            </div>
        </mat-expansion-panel>

        <!-- Exit Rules -->
        <mat-expansion-panel>
            <mat-expansion-panel-header>
                <mat-panel-title>
                    <mat-icon>exit_to_app</mat-icon>
                    Exit Rules
                </mat-panel-title>
            </mat-expansion-panel-header>

            <div class="section-content">
                <p>
                    <strong>Position-level exit rules</strong> provide faster exits than waiting for signals to flip.
                    These protect individual positions using price-based triggers and run automatically when new
                    market data arrives.
                </p>

                <div class="limit-card">
                    <strong>Status: Configurable</strong>
                    <p>Set <code>EXIT_RULES_ENABLED=true</code> in Admin → Exit Rules to activate.</p>
                    <p>When enabled, the <strong>Exit Consumer</strong> evaluates all active positions
                    after each market data update.</p>
                </div>

                <h4>How It Works</h4>
                <ol>
                    <li>Market data ingestion publishes <code>batch_complete</code> event</li>
                    <li>Exit Consumer loads all active positions from <code>position_states</code> table</li>
                    <li>For each position, fetches recent prices and calculates ATR</li>
                    <li>Evaluates trailing stop, ATR exit, and persistence filter</li>
                    <li>If exit triggered, publishes to <code>targets</code> stream with exposure=0</li>
                    <li>Order Consumer generates sell order to close position</li>
                </ol>

                <h4>Trailing Stop</h4>
                <p>Exit if price retraces X ATRs from peak since entry:</p>
                <ul>
                    <li><strong>Long:</strong> Exit if price drops below (Peak - X×ATR)</li>
                    <li><strong>Short:</strong> Exit if price rises above (Trough + X×ATR)</li>
                </ul>
                <div class="formula">
                    Default: <code>TRAILING_STOP_ATR=3.0</code><br>
                    Example: Peak=$105, ATR=$2, Trigger at $105 - (3×$2) = $99
                </div>

                <h4>ATR Exit</h4>
                <p>Exit if price moves Y ATRs against entry price:</p>
                <ul>
                    <li><strong>Long:</strong> Exit if price drops below (Entry - Y×ATR)</li>
                    <li><strong>Short:</strong> Exit if price rises above (Entry + Y×ATR)</li>
                </ul>
                <div class="formula">
                    Default: <code>ATR_EXIT_MULTIPLE=2.0</code><br>
                    Example: Entry=$100, ATR=$2, Exit if price hits $96
                </div>

                <h4>Persistence Filter</h4>
                <p>Prevents whipsaws by requiring signal to persist before flipping:</p>
                <ul>
                    <li>When signal direction changes, position is <strong>not</strong> immediately flipped</li>
                    <li>New direction must persist for <code>PERSISTENCE_DAYS</code> consecutive days</li>
                    <li>Reduces trading frequency in choppy markets</li>
                </ul>
                <div class="formula">
                    Default: <code>PERSISTENCE_DAYS=3</code><br>
                    Signal must stay bearish for 3 days before long position flips to short
                </div>

                <h4>ATR Calculation</h4>
                <p>Average True Range measures volatility using high/low/close:</p>
                <div class="formula">
                    TR = max(High - Low, |High - Close<sub>prev</sub>|, |Low - Close<sub>prev</sub>|)<br>
                    ATR = <code>ATR_PERIOD</code>-day average of TR (default: 14)
                </div>

                <h4>Position State Tracking</h4>
                <p>The system tracks for each position:</p>
                <table>
                    <tr><th>Field</th><th>Purpose</th></tr>
                    <tr><td>entry_price</td><td>Price when position was opened</td></tr>
                    <tr><td>peak_price</td><td>Highest price since entry (for longs)</td></tr>
                    <tr><td>trough_price</td><td>Lowest price since entry (for shorts)</td></tr>
                    <tr><td>entry_atr</td><td>ATR at time of entry</td></tr>
                    <tr><td>pending_direction</td><td>Direction signal is trying to flip to</td></tr>
                    <tr><td>consecutive_flip_days</td><td>Days signal has persisted in new direction</td></tr>
                </table>

                <h4>Configuration</h4>
                <table>
                    <tr><th>Setting</th><th>Default</th><th>Description</th></tr>
                    <tr>
                        <td><code>EXIT_RULES_ENABLED</code></td>
                        <td>false</td>
                        <td>Master toggle for exit rules</td>
                    </tr>
                    <tr>
                        <td><code>TRAILING_STOP_ATR</code></td>
                        <td>3.0</td>
                        <td>ATR multiple for trailing stop</td>
                    </tr>
                    <tr>
                        <td><code>ATR_EXIT_MULTIPLE</code></td>
                        <td>2.0</td>
                        <td>ATR multiple for loss-based exit</td>
                    </tr>
                    <tr>
                        <td><code>ATR_PERIOD</code></td>
                        <td>14</td>
                        <td>Days for ATR calculation</td>
                    </tr>
                    <tr>
                        <td><code>PERSISTENCE_DAYS</code></td>
                        <td>3</td>
                        <td>Days signal must persist before flip</td>
                    </tr>
                </table>
            </div>
        </mat-expansion-panel>

        <!-- Diversification Controls -->
        <mat-expansion-panel>
            <mat-expansion-panel-header>
                <mat-panel-title>
                    <mat-icon>scatter_plot</mat-icon>
                    Diversification Controls (Optional)
                </mat-panel-title>
            </mat-expansion-panel-header>

            <div class="section-content">
                <p>
                    <strong>Bucket caps and correlation awareness</strong> prevent concentration
                    in sectors or correlated assets.
                </p>

                <div class="limit-card">
                    <strong>Status: Disabled by Default</strong>
                    <p>Set <code>DIVERSIFICATION_ENABLED=true</code> to activate.</p>
                </div>

                <h4>Sector Caps</h4>
                <div class="limit-card">
                    <strong>Maximum 50% per GICS Sector</strong>
                    <p>Total exposure to any single sector (Technology, Healthcare, etc.) is capped.</p>
                    <p>Uses <code>InstrumentInfo.sector</code> field from database.</p>
                </div>

                <h4>Asset Class Caps</h4>
                <div class="limit-card">
                    <strong>Maximum 60% per Asset Class</strong>
                    <p>Total exposure to any asset class (Equity, Fixed Income, Commodity) is capped.</p>
                </div>

                <h4>Correlation Throttle</h4>
                <p>Reduces position adds when highly correlated with existing holdings:</p>
                <ul>
                    <li><strong>Threshold:</strong> Correlation > 0.70 triggers throttle</li>
                    <li><strong>Action:</strong> New position scaled to 50% of target</li>
                    <li><strong>Lookback:</strong> 60-day rolling correlation window</li>
                </ul>
            </div>
        </mat-expansion-panel>

        <!-- Signal Enhancement -->
        <mat-expansion-panel>
            <mat-expansion-panel-header>
                <mat-panel-title>
                    <mat-icon>auto_fix_high</mat-icon>
                    Signal Enhancement (Optional)
                </mat-panel-title>
            </mat-expansion-panel-header>

            <div class="section-content">
                <p>
                    Signal enhancement adjusts raw trend signals using market context data to improve
                    risk-adjusted returns. Each factor can be independently enabled.
                </p>

                <div class="limit-card">
                    <strong>Status: Disabled by Default</strong>
                    <p>Set <code>ENHANCEMENT_ENABLED=true</code> to activate.</p>
                    <p><em>Note: Missing data is handled gracefully—factors default to 1.0 multiplier when data is unavailable.</em></p>
                </div>

                <h4>1. Conviction Factor</h4>
                <p>Scales positions based on trend strength:</p>
                <div class="formula-card">
                    <code>conviction = scale_min + (1 - scale_min) × min(1, |lookback_return| / min_return)</code>
                </div>
                <ul>
                    <li><strong>Strong trends</strong> (return > 2%): Full position size</li>
                    <li><strong>Weak trends</strong> (return < 2%): Scaled down to 50-100%</li>
                    <li><strong>Effect:</strong> Concentrates capital in higher-conviction signals</li>
                </ul>

                <h4>2. Sentiment Factor</h4>
                <p>Adjusts based on market sentiment data (when available):</p>
                <div class="formula-card">
                    <code>adjustment = 1.0 ± (sentiment_weight × normalized_sentiment)</code>
                </div>
                <ul>
                    <li><strong>Contrarian mode</strong> (default): Reduces longs when sentiment extremely bullish</li>
                    <li><strong>Momentum mode:</strong> Aligns position size with sentiment direction</li>
                    <li><strong>Max impact:</strong> ±30% position adjustment</li>
                </ul>

                <h4>3. Regime Factor</h4>
                <p>Reduces exposure during stressed market conditions:</p>
                <table class="example-table">
                    <tr>
                        <th>Indicator</th>
                        <th>Threshold</th>
                        <th>Action</th>
                    </tr>
                    <tr>
                        <td>VIX Level</td>
                        <td>&gt; 25</td>
                        <td>Scale to 60%</td>
                    </tr>
                    <tr>
                        <td>Market Breadth</td>
                        <td>&lt; 40%</td>
                        <td>Scale to 60%</td>
                    </tr>
                </table>
                <p>When either condition is met, positions are reduced to the defensive scale factor.</p>

                <h4>4. Quality Factor</h4>
                <p>Tilts toward more stable instruments using three metrics:</p>
                <ul>
                    <li><strong>Market Cap:</strong> Slight preference for larger companies (log-scaled)</li>
                    <li><strong>Beta:</strong> Reduces high-beta positions, increases low-beta</li>
                    <li><strong>Liquidity:</strong> Slight preference for higher average volume</li>
                </ul>
                <div class="limit-card">
                    <strong>Combined Effect</strong>
                    <p>Quality adjustment typically ranges from 0.85× to 1.15× based on instrument characteristics.</p>
                </div>

                <h4>Enhancement Pipeline</h4>
                <p>Factors are applied multiplicatively in sequence:</p>
                <div class="formula-card">
                    <code>final_weight = raw_weight × conviction × sentiment × regime × quality</code>
                </div>
                <p>Each factor's contribution is logged for observability and debugging.</p>
            </div>
        </mat-expansion-panel>

        <!-- Order Sizing -->
        <mat-expansion-panel>
            <mat-expansion-panel-header>
                <mat-panel-title>
                    <mat-icon>straighten</mat-icon>
                    Order Sizing
                </mat-panel-title>
            </mat-expansion-panel-header>

            <div class="section-content">
                <p>
                    Orders are sized with support for <strong>fractional shares</strong> and dynamic
                    minimum notional thresholds.
                </p>

                <h4>Fractional Sizing</h4>
                <div class="limit-card">
                    <strong>Enabled by Default</strong>
                    <p>Supports up to 4 decimal places for precise position sizing.</p>
                    <p>Compatible with Alpaca fractional share orders.</p>
                </div>

                <h4>Minimum Notional</h4>
                <p>Orders below the minimum threshold are skipped to avoid churn:</p>
                <table class="example-table">
                    <tr>
                        <th>Mode</th>
                        <th>Calculation</th>
                    </tr>
                    <tr>
                        <td><code>fixed</code></td>
                        <td>$50 minimum (default)</td>
                    </tr>
                    <tr>
                        <td><code>nav_scaled</code></td>
                        <td>max($50, 5 bps of NAV)</td>
                    </tr>
                    <tr>
                        <td><code>liquidity_scaled</code></td>
                        <td>max($50, 0.1% of avg volume)</td>
                    </tr>
                </table>

                <h4>Short Selling</h4>
                <div class="limit-card">
                    <strong>Enabled by Default</strong>
                    <p>Set <code>ALLOW_SHORT_SELLING=false</code> to disable.</p>
                    <p>When disabled, only long positions are taken.</p>
                </div>
            </div>
        </mat-expansion-panel>

        <!-- Observability & Metrics -->
        <mat-expansion-panel>
            <mat-expansion-panel-header>
                <mat-panel-title>
                    <mat-icon>analytics</mat-icon>
                    Observability & Metrics
                </mat-panel-title>
            </mat-expansion-panel-header>

            <div class="section-content">
                <p>
                    The system emits <strong>structured metrics</strong> for all trading decisions,
                    enabling real-time monitoring and debugging.
                </p>

                <h4>Metrics API Endpoints</h4>
                <table class="example-table">
                    <tr>
                        <th>Endpoint</th>
                        <th>Description</th>
                    </tr>
                    <tr>
                        <td><code>/api/v1/metrics/summary</code></td>
                        <td>Aggregated metrics over time period</td>
                    </tr>
                    <tr>
                        <td><code>/api/v1/metrics/events</code></td>
                        <td>Recent metric events with filtering</td>
                    </tr>
                    <tr>
                        <td><code>/api/v1/metrics/stream</code></td>
                        <td>Real-time SSE stream</td>
                    </tr>
                    <tr>
                        <td><code>/api/v1/metrics/categories</code></td>
                        <td>Available metric categories</td>
                    </tr>
                </table>

                <h4>Metric Categories</h4>
                <ul>
                    <li><strong>signal</strong> - Signal generation, confirmation checks</li>
                    <li><strong>exit</strong> - Trailing stops, ATR exits, persistence blocks</li>
                    <li><strong>diversification</strong> - Sector caps, correlation throttles</li>
                    <li><strong>order</strong> - Order sizing, skipped orders, created orders</li>
                    <li><strong>risk</strong> - Single caps, gross exposure, drawdown scaling</li>
                    <li><strong>pipeline</strong> - Batch processing completion</li>
                </ul>

                <h4>Redis Stream</h4>
                <p>All metrics are published to the <code>metrics</code> Redis stream for real-time consumers.</p>
            </div>
        </mat-expansion-panel>

        <!-- Configuration Reference -->
        <mat-expansion-panel>
            <mat-expansion-panel-header>
                <mat-panel-title>
                    <mat-icon>settings</mat-icon>
                    Configuration Reference
                </mat-panel-title>
            </mat-expansion-panel-header>

            <div class="section-content">
                <p>
                    All configuration is loaded from environment variables via <code>config.py</code>.
                    Set values in your <code>.env</code> file or system environment.
                </p>

                <table mat-table [dataSource]="parameters" class="param-table mat-elevation-z1">
                    <ng-container matColumnDef="parameter">
                        <th mat-header-cell *matHeaderCellDef>Parameter</th>
                        <td mat-cell *matCellDef="let row">{{ row.parameter }}</td>
                    </ng-container>

                    <ng-container matColumnDef="default">
                        <th mat-header-cell *matHeaderCellDef>Default</th>
                        <td mat-cell *matCellDef="let row"><code>{{ row.default }}</code></td>
                    </ng-container>

                    <ng-container matColumnDef="description">
                        <th mat-header-cell *matHeaderCellDef>Description</th>
                        <td mat-cell *matCellDef="let row">{{ row.description }}</td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                </table>
            </div>
        </mat-expansion-panel>

        <!-- Rebalancing Schedule -->
        <mat-expansion-panel>
            <mat-expansion-panel-header>
                <mat-panel-title>
                    <mat-icon>schedule</mat-icon>
                    Rebalancing Schedule
                </mat-panel-title>
            </mat-expansion-panel-header>

            <div class="section-content">
                <h4>Daily Process</h4>
                <ol>
                    <li><strong>After Market Close (5:15 PM ET)</strong> - Ingest daily bars</li>
                    <li><strong>Signal Generation</strong> - Compute momentum and volatility</li>
                    <li><strong>Portfolio Optimization</strong> - Calculate target exposures with caps</li>
                    <li><strong>Order Generation</strong> - Diff current vs target positions</li>
                    <li><strong>Order Submission</strong> - Submit MOO orders to Alpaca (queued for next open)</li>
                </ol>

                <h4>Execution Policy</h4>
                <ul>
                    <li><strong>Default Mode (<code>ORDER_EXECUTION_TYPE=moo</code>):</strong> Market-on-Open orders using Alpaca's <code>OPG</code> time-in-force. Orders submitted after close are queued and execute at 9:30 AM ET next trading day.</li>
                    <li><strong>Alternative (<code>ORDER_EXECUTION_TYPE=market</code>):</strong> Immediate market orders with <code>DAY</code> time-in-force. Only executes when market is open; orders submitted after close are marked PENDING.</li>
                    <li><strong>Minimum Notional:</strong> $50 per order (avoid churn)</li>
                    <li><strong>Idempotency:</strong> Orders have unique keys to prevent duplicates</li>
                </ul>

                <h4>MOO Execution Timeline</h4>
                <div class="limit-card">
                    <strong>T+0 (After Close)</strong>
                    <p>5:15 PM ET: Pipeline runs, generates signals, submits MOO orders to Alpaca.</p>
                </div>
                <div class="limit-card">
                    <strong>T+1 (Market Open)</strong>
                    <p>9:30 AM ET: Alpaca executes queued MOO orders at opening auction price.</p>
                </div>
            </div>
        </mat-expansion-panel>
    </mat-accordion>
</div>
